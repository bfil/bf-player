/* 
 * BF-Player v0.5
 * http://b-fil.com/
 * 
 * Copyright (c) 2011 Bruno Filippone
 * 
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * Date: Mar 02 2011
 */
var HTML5={isAudioSupported:function(){return !!(document.createElement("audio").canPlayType)},isRangeSupported:function(){var a=document.createElement("input");a.setAttribute("type","range");return a.type=="range"},isProgressSupported:function(){var a=document.createElement("audio");return(a!=null&&a.buffered!=undefined&&a.buffered.length!=0)}};var Util={getAudioType:function(a){switch(a.toLowerCase()){case"ogg":return"audio/ogg";case"mp3":return"audio/mpeg";case"wav":return"audio/wav";default:return null}},getFileExtension:function(a){return a.substr(a.lastIndexOf(".")+1)},secondsToTime:function(b){if(!isNaN(b)&&b!=0){var c=parseInt(b/60);var a=parseInt(b-(c*60));if(a<10){a="0"+a}return c+":"+a}else{return"0:00"}},isFileSupported:function(c){var b=Util.getFileExtension(c);var a=Util.getAudioType(b);return(a!=null&&document.createElement("audio").canPlayType(a))}};function Player(s,v,d){var i=this;var s=s;var a=new Object();a.player=$("#"+s);var y=null;var r=null;var c=new Object();c.volume=100;c.autoplay=false;c.autoadvance=false;c.repeatAll=false;if(d!=null){$.extend(c,d)}c.loading=false;c.playing=false;c.disabled=false;var q=function(){return a.player.length==1};var t=function(){if(q()){h();if(!HTML5.isAudioSupported()){b()}else{u();if(v!=null){i.setTracks(v)}}if(!HTML5.isRangeSupported()){a.position.hide();a.volume.hide()}}else{c.disabled=true}};var e=function(z){c.loading=z;if(z){a.loading.show()}else{a.loading.hide()}};var u=function(){y=new Audio();y.addEventListener("loadstart",function(){e(true)},false);y.addEventListener("loadedmetadata",function(){var B=y.duration;var A=y.currentTime;var z=(A/B)*100;if(isNaN(z)){z=0}a.position.val(z);a.trackTime.text(Util.secondsToTime(A));a.trackDuration.text(Util.secondsToTime(B))},false);y.addEventListener("loadeddata",function(){e(false)},false);y.addEventListener("stalled",function(){e(true)},false);y.addEventListener("waiting",function(){e(true)},false);y.addEventListener("playing",function(){e(false)},false);y.addEventListener("seeking",function(){e(true)},false);y.addEventListener("seeked",function(){e(false)},false);y.addEventListener("timeupdate",function(){var B=y.duration;var A=y.currentTime;var z=(A/B)*100;if(isNaN(z)){z=0}a.position.val(z);a.trackTime.text(Util.secondsToTime(A));a.trackDuration.text(Util.secondsToTime(B))},false);y.addEventListener("ended",function(){if(c.autoadvance){var B=g();var A=B.next("li");if(A.html()!=null){var z=r[A.attr("id")];f(z)}else{if(c.repeatAll){f(r[0])}else{m()}}}else{m()}},false);if(HTML5.isProgressSupported()){y.addEventListener("progress",function(){var z=parseInt(((y.buffered.end(0)/y.duration)*100),10);a.loadingProgress.val(z)},false)}else{a.loadingProgress.hide()}};var j=function(A,z){r[r.length]=new Track(a.trackList,A,z)};this.setTracks=function(B){if(!c.disabled){r=new Array();a.trackList.empty();for(var A in B){var z=B[A];j(z.title,z.files)}if(r.length>0){f(r[0])}p();if(c.autoplay){w()}}};var o=function(){return $("#"+s+"Playlist li")};var g=function(){return $("#"+s+"Playlist li.playerCurrent")};var n=function(){return $("#"+s+"Playlist li div a")};var h=function(){a.player.addClass("player");a.player.empty();var D=$("<div></div>").addClass("playerDisplay").appendTo(a.player);var C=$("<span></span>").addClass("playerInfo").appendTo(D);a.track=$("<span></span>").addClass("playerTrack").attr("id",s+"Track").appendTo(C).text("Stand By...");a.playerTime=$("<span></span>").addClass("playerTime").appendTo(C);a.trackTime=$("<span></span>").addClass("playerTrackTime").attr("id",s+"TrackTime").appendTo(a.playerTime).text("0:00");a.playerTime.append(" / ");a.trackDuration=$("<span></span>").addClass("playerTrackDuration").attr("id",s+"TrackDuration").appendTo(a.playerTime).text("0:00");a.position=$('<input type="range">').addClass("playerPositionSlider").attr("min",0).attr("max",100).attr("value",0).attr("id",s+"PositionSlider").appendTo(a.player);a.loadingProgress=$("<progress>").addClass("playerLoadingProgress").attr("min",0).attr("max",100).attr("value",0).attr("id",s+"LoadingProgress").appendTo(a.player);a.controlBar=$("<div></div>").addClass("playerControlBar").appendTo(a.player);var A=$("<ul></ul>").addClass("playerControls").appendTo(a.controlBar);a.prev=$("<li></li>").addClass("playerBtnPrev").attr("id",s+"BtnPrev").append('<a href=""></a>').appendTo(A);a.playPause=$("<li></li>").addClass("playerBtnPlay").attr("id",s+"BtnPlayPause").append('<a href=""></a>').appendTo(A);a.stop=$("<li></li>").addClass("playerBtnStop").attr("id",s+"BtnStop").append('<a href=""></a>').appendTo(A);a.next=$("<li></li>").addClass("playerBtnNext").attr("id",s+"BtnNext").append('<a href=""></a>').appendTo(A);a.playlistToggler=$("<li></li>").addClass("playerBtnPlaylist").attr("id",s+"BtnPlaylist").append('<a href=""></a>').appendTo(A);a.loading=$("<div></div>").addClass("playerLoading").append('<div id="block1" class="playerLoadingBlock"></a>').append('<div id="block2" class="playerLoadingBlock"></a>').append('<div id="block3" class="playerLoadingBlock"></a>').appendTo(a.controlBar);var z=$("<div></div>").addClass("playerVolume").appendTo(a.controlBar);a.volume=$('<input type="range">').addClass("playerVolumeSlider").attr("min",0).attr("max",100).attr("value",c.volume).attr("id",s+"VolumeSlider").appendTo(z);var B=$("<div></div>").appendTo(z);var E=$("<ul></ul>").addClass("playerControls").appendTo(B);a.volumeButton=$("<li></li>").addClass("playerBtnVolume").attr("id",s+"BtnVolume").append('<a href=""></a>').appendTo(E);a.playlist=$("<div></div>").addClass("playerPlaylist").attr("id",s+"Playlist").appendTo(a.player);a.trackList=$("<ol></ol>").attr("id",s+"TrackList").appendTo(a.playlist)};var w=function(){if(a.playPause.hasClass("playerBtnPlay")){a.playPause.removeClass("playerBtnPlay");a.playPause.addClass("playerBtnPause");c.playing=true;if(y.src!=null){y.play()}}else{a.playPause.removeClass("playerBtnPause");a.playPause.addClass("playerBtnPlay");c.playing=false;if(y.src!=null){y.pause()}}};var m=function(){if(y.src!=null){c.playing=false;y.pause();if(y.currentTime!=0){y.currentTime=0}}a.position.val(0);if(a.playPause.hasClass("playerBtnPause")){a.playPause.removeClass("playerBtnPause");a.playPause.addClass("playerBtnPlay")}};var k=function(){var B=g();var A=B.prev("li");if(A.html()!=null){var z=r[A.attr("id")];f(z)}};var l=function(){var B=g();var A=B.next("li");if(A.html()!=null){var z=r[A.attr("id")];f(z)}};var p=function(){o().unbind("click").click(function(A){var B=$(this).attr("id");var z=r[B];f(z);A.preventDefault()});n().unbind("click").click(function(B){var C=$(this).parent().parent().attr("id");var A=$(this).attr("id");var z=r[C].files[A];if(Util.isFileSupported(z.uri)){x(z)}else{$(this).addClass("playerTypeNotSupported").attr("title","Format Not Supported By The Browser!")}if(B.stopPropagation){B.stopPropagation()}else{B.cancelBubble=true}B.preventDefault()});a.position.unbind("change").change(function(){y.seeking=true;y.pause()});a.position.unbind("mouseup").mouseup(function(){y.currentTime=Math.round($(this).val()/100*y.duration);y.seeking=false;if(c.playing){y.play()}});a.volume.unbind("change").change(function(){if($(this).val()>0){y.muted=false;if(a.volumeButton.hasClass("playerBtnMute")){a.volumeButton.removeClass("playerBtnMute")}}c.volume=$(this).val();y.volume=$(this).val()/100});a.playPause.unbind("click").click(function(z){w();z.preventDefault()});a.stop.unbind("click").click(function(z){m();z.preventDefault()});a.prev.unbind("click").click(function(z){k();z.preventDefault()});a.next.unbind("click").click(function(z){l();z.preventDefault()});a.playlistToggler.unbind("click").click(function(z){a.playlist.toggle();z.preventDefault()});a.volumeButton.unbind("click").click(function(z){if($(this).hasClass("playerBtnMute")){$(this).removeClass("playerBtnMute");a.volume.val(c.volume);y.muted=false}else{$(this).addClass("playerBtnMute");a.volume.val(0);y.muted=true}z.preventDefault()})};var f=function(z){if(y.src!=null){y.pause()}var A=z.first();if(A!=null){x(A)}};var x=function(A){if(!c.loading){y.src=A.uri;y.load();var z=A.track;$("#"+s+"Playlist li").removeClass("playerCurrent");z.trackElement.addClass("playerCurrent");$("#"+s+"Playlist div a").removeClass("playerCurrentType");A.fileElement.addClass("playerCurrentType");$("#"+s+"Track").text(z.title);$("#"+s+"PositionSlider").val(0);if(c.playing){y.play()}}};var b=function(){c.disabled=true;a.track.text("Your Browser Doesn't Support HTML5 Audio");a.track.addClass("playerNotSupported");a.playerTime.hide();a.position.hide();a.loadingProgress.hide();a.controlBar.hide();a.playlist.hide()};t()}function Track(d,e,c){var b=function(j,k,i){var f=$("<li></li>").attr("id",j.children("li").length);var g=$('<a href=""></a>').text(k).appendTo(f);var h=$("<div></div>").appendTo(f);f.appendTo(j);return f};this.trackElement=b(d,e,c);this.title=e;this.files=new Array();for(var a=0;a<c.length;a++){this.files[a]=new File(this,c[a])}this.first=function(){var h;for(var f in this.files){var g=this.files[f];if(Util.isFileSupported(g.uri)){h=g;break}}return h}}function File(a,c){var b=function(e,g){var d=e.trackElement.children("div").first();var f=$("<a></a>").attr("id",d.children("a").length).attr("href",g).text(Util.getFileExtension(g).toUpperCase()).appendTo(d);d.append(" ");return f};this.track=a;this.fileElement=b(a,c);this.uri=c};